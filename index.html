<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹•ç”»ã‹ã‚‰GIFã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ›</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #fafafa;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e8ecff;
        }

        .upload-icon {
            font-size: 48px;
            color: #999;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #666;
            font-size: 16px;
        }

        #fileInput {
            display: none;
        }

        .settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
        }
        
        .size-mode-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .size-mode-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        
        .size-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            transition: all 0.3s ease;
        }
        
        .size-input-group {
            display: flex;
            flex-direction: column;
        }
        
        .size-input-group.hidden {
            display: none;
        }
        
        .calculated-value {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .setting-group label {
            color: #555;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .setting-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .setting-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .setting-group .hint {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .progress-container {
            display: none;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
            text-align: center;
        }

        .result-container {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
        }

        .result-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .result-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #resultGif {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .file-info {
            display: none;
            background: #e8f4ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #0066cc;
            font-size: 14px;
        }

        .error-message {
            display: none;
            background: #ffe8e8;
            color: #cc0000;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .warning-message {
            display: none;
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .logs-container {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .logs-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .logs-content {
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            color: #333;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .process-steps {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .step-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .step-item.active {
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
            border: 1px solid #667eea;
        }

        .step-item.completed {
            background: #e8f8f5;
            border: 1px solid #4caf50;
        }

        .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 14px;
            background: #e0e0e0;
            color: #666;
        }

        .step-item.active .step-icon {
            background: #667eea;
            color: white;
        }

        .step-item.completed .step-icon {
            background: #4caf50;
            color: white;
        }

        .step-text {
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        .palette-preview {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            text-align: center;
        }

        .palette-title {
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .palette-image {
            display: inline-block;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .palette-image img {
            display: block;
            width: 256px;
            height: 256px;
            image-rendering: pixelated;
        }

        .palette-info {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }

        .fs-info {
            display: none;
            margin: 10px 0;
            padding: 10px;
            background: #e8f4ff;
            border-radius: 5px;
            font-size: 12px;
            color: #0066cc;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ å‹•ç”» â†’ GIFã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ›</h1>
        <p class="subtitle">é«˜å“è³ªãªGIFã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ç”Ÿæˆã—ã¾ã™ï¼ˆã‚µãƒ¼ãƒãƒ¼ä¸è¦ï¼‰</p>
        
        <div class="warning-message" id="warningMessage">
            âš ï¸ å¤‰æ›ä¸­ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãŒä¸€æ™‚çš„ã«å›ºã¾ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">
                ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ<br>
                ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            </div>
            <input type="file" id="fileInput" accept="video/*">
        </div>

        <div class="file-info" id="fileInfo"></div>
        <div class="error-message" id="errorMessage"></div>

        <div class="settings">
            <div class="size-mode-selector">
                <label for="sizeMode" style="display: block; margin-bottom: 8px; color: #555; font-size: 14px; font-weight: 500;">
                    ã‚µã‚¤ã‚ºæŒ‡å®šæ–¹æ³•
                </label>
                <select id="sizeMode">
                    <option value="both">å¹…ã¨é«˜ã•ã‚’æŒ‡å®šã™ã‚‹</option>
                    <option value="width">å¹…ã‚’æŒ‡å®šã™ã‚‹ï¼ˆç¸¦æ¨ªæ¯”ç¶­æŒï¼‰</option>
                    <option value="height">é«˜ã•ã‚’æŒ‡å®šã™ã‚‹ï¼ˆç¸¦æ¨ªæ¯”ç¶­æŒï¼‰</option>
                </select>
            </div>
            
            <div class="size-inputs">
                <div class="size-input-group" id="widthGroup">
                    <label for="widthInput">å¹… (px)</label>
                    <input type="number" id="widthInput" value="600" placeholder="ä¾‹: 600" min="1">
                    <span class="calculated-value" id="widthCalculated" style="display: none;"></span>
                </div>
                <div class="size-input-group" id="heightGroup">
                    <label for="heightInput">é«˜ã• (px)</label>
                    <input type="number" id="heightInput" value="400" placeholder="ä¾‹: 400" min="1">
                    <span class="calculated-value" id="heightCalculated" style="display: none;"></span>
                </div>
            </div>
            
            <div class="setting-group" style="margin-top: 20px;">
                <label for="fpsInput">FPS (ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ)</label>
                <input type="number" id="fpsInput" value="30" min="1" max="60" placeholder="ä¾‹: 30">
                <span class="hint">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 30</span>
            </div>
        </div>

        <div class="button-group">
            <button class="btn btn-primary" id="convertBtn" disabled>
                GIFã«å¤‰æ›
            </button>
            <button class="btn btn-secondary" id="resetBtn">
                ãƒªã‚»ãƒƒãƒˆ
            </button>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">æº–å‚™ä¸­...</div>
        </div>

        <div class="process-steps" id="processSteps">
            <div class="step-item" id="step1">
                <div class="step-icon">1</div>
                <div class="step-text">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¡ãƒ¢ãƒªã«èª­ã¿è¾¼ã¿</div>
            </div>
            <div class="step-item" id="step2">
                <div class="step-icon">2</div>
                <div class="step-text">ãƒ‘ãƒ¬ãƒƒãƒˆç”Ÿæˆä¸­</div>
            </div>
            <div class="step-item" id="step3">
                <div class="step-icon">3</div>
                <div class="step-text">GIFã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ›ä¸­</div>
            </div>
            <div class="step-item" id="step4">
                <div class="step-icon">4</div>
                <div class="step-text">çµæœã‚’æº–å‚™ä¸­</div>
            </div>
        </div>

        <div class="palette-preview" id="palettePreview">
            <div class="palette-title">ğŸ¨ ç”Ÿæˆã•ã‚ŒãŸãƒ‘ãƒ¬ãƒƒãƒˆ</div>
            <div class="palette-image">
                <img id="paletteImg" alt="ãƒ‘ãƒ¬ãƒƒãƒˆç”»åƒ">
            </div>
            <div class="palette-info" id="paletteInfo"></div>
        </div>

        <div class="fs-info" id="fsInfo"></div>

        <div class="logs-container" id="logsContainer">
            <div class="logs-title">å¤‰æ›ãƒ­ã‚°</div>
            <div class="logs-content" id="logsContent"></div>
        </div>

        <div class="result-container" id="resultContainer">
            <div class="result-title">âœ¨ å¤‰æ›å®Œäº†ï¼</div>
            <div class="result-content">
                <img id="resultGif" alt="å¤‰æ›ã•ã‚ŒãŸGIF">
                <button class="btn btn-primary" id="downloadBtn">
                    ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
        </div>
    </div>

    <!-- FFmpeg.wasm CDNï¼ˆã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ç‰ˆ - ãƒãƒ¼ã‚¸ãƒ§ãƒ³çµ±ä¸€ï¼‰ -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.1/dist/ffmpeg.min.js"></script>
    <script>
        (async () => {
            const { createFFmpeg, fetchFile } = FFmpeg;
            
            let ffmpeg = null;
            let isProcessing = false;
            let selectedFile = null;
            let outputBlob = null;

            // DOMè¦ç´ 
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const errorMessage = document.getElementById('errorMessage');
            const warningMessage = document.getElementById('warningMessage');
            const convertBtn = document.getElementById('convertBtn');
            const resetBtn = document.getElementById('resetBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const resultContainer = document.getElementById('resultContainer');
            const resultGif = document.getElementById('resultGif');
            const downloadBtn = document.getElementById('downloadBtn');
            const widthInput = document.getElementById('widthInput');
            const heightInput = document.getElementById('heightInput');
            const fpsInput = document.getElementById('fpsInput');
            const logsContainer = document.getElementById('logsContainer');
            const logsContent = document.getElementById('logsContent');
            const processSteps = document.getElementById('processSteps');
            const palettePreview = document.getElementById('palettePreview');
            const paletteImg = document.getElementById('paletteImg');
            const paletteInfo = document.getElementById('paletteInfo');
            const fsInfo = document.getElementById('fsInfo');
            const sizeMode = document.getElementById('sizeMode');
            const widthGroup = document.getElementById('widthGroup');
            const heightGroup = document.getElementById('heightGroup');
            const widthCalculated = document.getElementById('widthCalculated');
            const heightCalculated = document.getElementById('heightCalculated');

            // FFmpegåˆæœŸåŒ–ï¼ˆçœŸã®ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ç‰ˆï¼š@ffmpeg/core-stä½¿ç”¨ï¼‰
            async function initFFmpeg() {
                if (!ffmpeg) {
                    // mainName: 'main' ãŒé‡è¦ï¼šã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰ã‚’æŒ‡å®š
                    ffmpeg = createFFmpeg({
                        mainName: 'main',  // ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ¢ãƒ¼ãƒ‰å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
                        corePath: 'https://unpkg.com/@ffmpeg/core-st@0.11.1/dist/ffmpeg-core.js',
                        log: true
                    });
                    
                    ffmpeg.setLogger(({ type, message }) => {
                        if (message) {
                            console.log(message);
                            appendLog(message);
                        }
                    });
                    
                    ffmpeg.setProgress(({ ratio }) => {
                        const percent = Math.round(ratio * 100);
                        updateProgress(percent, `å¤‰æ›ä¸­... ${percent}%`);
                    });
                }
                
                if (!ffmpeg.isLoaded()) {
                    updateProgress(5, 'FFmpeg.wasmï¼ˆã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ç‰ˆï¼‰ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                    await ffmpeg.load();
                    updateProgress(10, 'FFmpeg.wasmï¼ˆã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ç‰ˆï¼‰èª­ã¿è¾¼ã¿å®Œäº†');
                }
            }

            // ãƒ­ã‚°è¡¨ç¤º
            function appendLog(message) {
                logsContent.textContent += message + '\n';
                logsContent.scrollTop = logsContent.scrollHeight;
            }

            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }

            // ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤ºæ›´æ–°
            function updateStep(stepNumber, status = 'active') {
                for (let i = 1; i <= 4; i++) {
                    const step = document.getElementById(`step${i}`);
                    if (i < stepNumber) {
                        step.className = 'step-item completed';
                        step.querySelector('.step-icon').textContent = 'âœ“';
                    } else if (i === stepNumber) {
                        step.className = `step-item ${status}`;
                        if (status === 'completed') {
                            step.querySelector('.step-icon').textContent = 'âœ“';
                        }
                    } else {
                        step.className = 'step-item';
                        step.querySelector('.step-icon').textContent = i;
                    }
                }
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±è¡¨ç¤º
            function showFSInfo(message) {
                fsInfo.textContent = message;
                fsInfo.style.display = 'block';
            }
            
            // å‹•ç”»ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
            let videoMetadata = {
                width: 600,
                height: 400,
                aspectRatio: 1.5
            };
            
            // ã‚µã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
            function updateSizeMode() {
                const mode = sizeMode.value;
                
                // è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
                widthGroup.style.display = 'flex';
                heightGroup.style.display = 'flex';
                widthCalculated.style.display = 'none';
                heightCalculated.style.display = 'none';
                widthInput.disabled = false;
                heightInput.disabled = false;
                
                switch(mode) {
                    case 'width':
                        // å¹…ã‚’æŒ‡å®šï¼ˆé«˜ã•ã¯è‡ªå‹•è¨ˆç®—ã§è¡¨ç¤ºï¼‰
                        heightInput.disabled = true;
                        heightInput.style.backgroundColor = '#f0f0f0';
                        calculateHeightFromWidth();
                        break;
                    case 'height':
                        // é«˜ã•ã‚’æŒ‡å®šï¼ˆå¹…ã¯è‡ªå‹•è¨ˆç®—ã§è¡¨ç¤ºï¼‰
                        widthInput.disabled = true;
                        widthInput.style.backgroundColor = '#f0f0f0';
                        calculateWidthFromHeight();
                        break;
                    case 'both':
                    default:
                        // ä¸¡æ–¹æŒ‡å®š
                        widthInput.style.backgroundColor = 'white';
                        heightInput.style.backgroundColor = 'white';
                        break;
                }
            }
            
            // å¹…ã‹ã‚‰é«˜ã•ã‚’è¨ˆç®—
            function calculateHeightFromWidth() {
                const width = parseInt(widthInput.value);
                if (!isNaN(width) && width > 0 && videoMetadata.aspectRatio) {
                    const calculatedHeight = Math.round(width / videoMetadata.aspectRatio);
                    heightInput.value = calculatedHeight;
                    heightCalculated.textContent = `ç¸¦æ¨ªæ¯” ${videoMetadata.aspectRatio.toFixed(2)} ã‚ˆã‚Šè‡ªå‹•è¨ˆç®—`;
                    heightCalculated.style.display = 'block';
                }
            }
            
            // é«˜ã•ã‹ã‚‰å¹…ã‚’è¨ˆç®—
            function calculateWidthFromHeight() {
                const height = parseInt(heightInput.value);
                if (!isNaN(height) && height > 0 && videoMetadata.aspectRatio) {
                    const calculatedWidth = Math.round(height * videoMetadata.aspectRatio);
                    widthInput.value = calculatedWidth;
                    widthCalculated.textContent = `ç¸¦æ¨ªæ¯” ${videoMetadata.aspectRatio.toFixed(2)} ã‚ˆã‚Šè‡ªå‹•è¨ˆç®—`;
                    widthCalculated.style.display = 'block';
                }
            }
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            sizeMode.addEventListener('change', updateSizeMode);
            
            widthInput.addEventListener('input', () => {
                if (sizeMode.value === 'width') {
                    calculateHeightFromWidth();
                }
            });
            
            heightInput.addEventListener('input', () => {
                if (sizeMode.value === 'height') {
                    calculateWidthFromHeight();
                }
            });

            // é€²æ—è¡¨ç¤º
            function updateProgress(percent, text) {
                progressFill.style.width = percent + '%';
                progressText.textContent = text;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    selectFile(file);
                }
            });

            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('video/')) {
                    selectFile(file);
                } else {
                    showError('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                }
            });

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
            async function selectFile(file) {
                const MAX_SIZE_MB = 50; // 50MBåˆ¶é™
                const fileSizeMB = file.size / 1024 / 1024;
                
                if (fileSizeMB > MAX_SIZE_MB) {
                    showError(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚${MAX_SIZE_MB}MBä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`);
                    return;
                }
                
                selectedFile = file;
                fileInfo.textContent = `é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: ${file.name} (${fileSizeMB.toFixed(2)} MB)`;
                fileInfo.style.display = 'block';
                
                if (fileSizeMB > 10) {
                    fileInfo.textContent += ' âš ï¸ å¤§ãã„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãŸã‚ã€å¤‰æ›ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™';
                }
                
                // å‹•ç”»ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚µã‚¤ã‚ºã‚’è‡ªå‹•è¨­å®š
                try {
                    const video = document.createElement('video');
                    video.preload = 'metadata';
                    
                    await new Promise((resolve, reject) => {
                        video.onloadedmetadata = () => {
                            // å‹•ç”»ã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
                            const videoWidth = video.videoWidth;
                            const videoHeight = video.videoHeight;
                            
                            // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                            videoMetadata.width = videoWidth;
                            videoMetadata.height = videoHeight;
                            videoMetadata.aspectRatio = videoWidth / videoHeight;
                            
                            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
                            widthInput.value = videoWidth.toString();
                            heightInput.value = videoHeight.toString();
                            
                            // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦è¡¨ç¤ºã‚’æ›´æ–°
                            updateSizeMode();
                            
                            fileInfo.textContent += ` | ã‚µã‚¤ã‚º: ${videoWidth}x${videoHeight}`;
                            
                            resolve();
                        };
                        
                        video.onerror = () => {
                            // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
                            console.log('ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨');
                            widthInput.value = '600';
                            heightInput.value = '-1';
                            resolve();
                        };
                        
                        // å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®URLã‚’ä½œæˆ
                        const url = URL.createObjectURL(file);
                        video.src = url;
                        
                        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
                        setTimeout(() => {
                            URL.revokeObjectURL(url);
                            resolve();
                        }, 5000);
                    });
                    
                } catch (error) {
                    console.error('ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                    widthInput.value = '600';
                    heightInput.value = '-1';
                }
                
                convertBtn.disabled = false;
            }

            // å¤‰æ›å‡¦ç†
            convertBtn.addEventListener('click', async () => {
                if (!selectedFile) {
                    showError('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }

                if (isProcessing) {
                    showError('ç¾åœ¨å¤‰æ›å‡¦ç†ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
                    return;
                }
                
                isProcessing = true;
                convertBtn.disabled = true;
                progressContainer.style.display = 'block';
                logsContainer.style.display = 'block';
                logsContent.textContent = '';
                resultContainer.style.display = 'none';
                warningMessage.style.display = 'block';
                processSteps.style.display = 'block';
                palettePreview.style.display = 'none';
                fsInfo.style.display = 'none';
                
                // ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆ
                for (let i = 1; i <= 4; i++) {
                    updateStep(i, '');
                }
                
                updateProgress(0, 'FFmpegã‚’åˆæœŸåŒ–ä¸­...');

                try {
                    // FFmpegåˆæœŸåŒ–
                    await initFFmpeg();
                    
                    // ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
                    updateStep(1, 'active');
                    updateProgress(15, 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’FFmpegã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«æ›¸ãè¾¼ã¿
                    ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(selectedFile));
                    updateStep(1, 'completed');
                    
                    updateProgress(25, 'å¤‰æ›æº–å‚™å®Œäº†...');
                    
                    // ã‚µã‚¤ã‚ºè¨­å®š
                    let width = widthInput.value || '600';
                    let height = heightInput.value || '400';
                    const fps = fpsInput.value || '30';
                    
                    // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ã‚µã‚¤ã‚ºã‚’è¨­å®š
                    const mode = sizeMode.value;
                    if (mode === 'width') {
                        height = '-1'; // FFmpegã«ç¸¦æ¨ªæ¯”ç¶­æŒã‚’ä»»ã›ã‚‹
                    } else if (mode === 'height') {
                        width = '-1'; // FFmpegã«ç¸¦æ¨ªæ¯”ç¶­æŒã‚’ä»»ã›ã‚‹
                    }
                    
                    const scale = `${width}:${height}`;
                    
                    // ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‘ãƒ¬ãƒƒãƒˆç”Ÿæˆã¨GIFå¤‰æ›
                    updateStep(2, 'active');
                    updateProgress(30, 'ãƒ‘ãƒ¬ãƒƒãƒˆã‚’ç”Ÿæˆä¸­...');
                    
                    // 1ã‚³ãƒãƒ³ãƒ‰ã§GIFã¨ãƒ‘ãƒ¬ãƒƒãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’åŒæ™‚ç”Ÿæˆ
                    await ffmpeg.run(
                        '-i', 'input.mp4',
                        '-filter_complex',
                        `[0:v]fps=${fps},scale=${scale}:flags=lanczos,split[s0][s1];` +
                        `[s0]palettegen[p];` +
                        `[p]split[p1][p2];` +
                        `[s1][p1]paletteuse=dither=bayer:bayer_scale=5:diff_mode=rectangle[gif];` +
                        `[p2]scale=256:256:flags=neighbor[palette_preview]`,
                        '-map', '[gif]', '-y', 'output.gif',
                        '-map', '[palette_preview]', '-frames:v', '1', '-y', 'palette_preview.png'
                    );
                    
                    updateStep(2, 'completed');
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±è¡¨ç¤º
                    try {
                        const files = ffmpeg.FS('readdir', '/');
                        const fileInfo = files.map(f => {
                            try {
                                const stat = ffmpeg.FS('stat', `/${f}`);
                                return `${f} (${stat.size} bytes)`;
                            } catch {
                                return f;
                            }
                        }).filter(f => !f.startsWith('dev') && !f.startsWith('proc') && !f.startsWith('tmp') && !f.startsWith('home'));
                        showFSInfo('ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ : ' + fileInfo.join(', '));
                    } catch (e) {
                        console.error('FS info error:', e);
                    }
                    
                    // ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ‘ãƒ¬ãƒƒãƒˆè¡¨ç¤º
                    updateStep(3, 'active');
                    updateProgress(60, 'ãƒ‘ãƒ¬ãƒƒãƒˆã‚’è¡¨ç¤ºä¸­...');
                    
                    // ãƒ‘ãƒ¬ãƒƒãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                    try {
                        const paletteData = ffmpeg.FS('readFile', 'palette_preview.png');
                        const paletteBlob = new Blob([paletteData.buffer], { type: 'image/png' });
                        const paletteUrl = URL.createObjectURL(paletteBlob);
                        paletteImg.src = paletteUrl;
                        paletteInfo.textContent = `ã‚µã‚¤ã‚º: ${paletteData.length} bytes | 256è‰²ãƒ‘ãƒ¬ãƒƒãƒˆ (16x16ãƒ”ã‚¯ã‚»ãƒ«)`;
                        palettePreview.style.display = 'block';
                    } catch (e) {
                        console.error('Palette preview error:', e);
                    }
                    
                    updateStep(3, 'completed');
                    
                    // ã‚¹ãƒ†ãƒƒãƒ—4: GIFç”Ÿæˆ
                    updateStep(4, 'active');
                    updateProgress(80, 'GIFã‚’æº–å‚™ä¸­...');
                    
                    updateProgress(90, 'çµæœã‚’æº–å‚™ä¸­...');
                    
                    // çµæœã‚’èª­ã¿è¾¼ã¿
                    const data = ffmpeg.FS('readFile', 'output.gif');
                    outputBlob = new Blob([data.buffer], { type: 'image/gif' });
                    const url = URL.createObjectURL(outputBlob);
                    
                    // çµæœè¡¨ç¤º
                    resultGif.src = url;
                    resultContainer.style.display = 'block';
                    
                    updateStep(4, 'completed');
                    updateProgress(100, 'å®Œäº†ï¼');
                    
                    // GIFãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è¡¨ç¤º
                    const gifSize = (data.length / 1024 / 1024).toFixed(2);
                    console.log(`GIFã‚µã‚¤ã‚º: ${gifSize} MB`);
                    
                    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    try {
                        ffmpeg.FS('unlink', 'input.mp4');
                        ffmpeg.FS('unlink', 'palette_preview.png');
                        ffmpeg.FS('unlink', 'output.gif');
                    } catch (e) {
                        console.log('Cleanup error:', e);
                    }
                    
                } catch (error) {
                    console.error('å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
                    showError('å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                } finally {
                    isProcessing = false;
                    convertBtn.disabled = false;
                    warningMessage.style.display = 'none';
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 2000);
                }
            });

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            downloadBtn.addEventListener('click', () => {
                if (outputBlob) {
                    const url = URL.createObjectURL(outputBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'output.gif';
                    a.click();
                    URL.revokeObjectURL(url);
                }
            });

            // ãƒªã‚»ãƒƒãƒˆ
            resetBtn.addEventListener('click', () => {
                selectedFile = null;
                outputBlob = null;
                fileInput.value = '';
                fileInfo.style.display = 'none';
                resultContainer.style.display = 'none';
                progressContainer.style.display = 'none';
                logsContainer.style.display = 'none';
                warningMessage.style.display = 'none';
                processSteps.style.display = 'none';
                palettePreview.style.display = 'none';
                fsInfo.style.display = 'none';
                convertBtn.disabled = true;
                widthInput.value = '600';
                heightInput.value = '400';
                fpsInput.value = '30';
                sizeMode.value = 'both';
                updateSizeMode();
            });
        })();
    </script>
</body>
</html>